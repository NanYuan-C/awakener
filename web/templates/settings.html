{% extends "base.html" %}

{% block title %}Settings - Awakener{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<!--
  Settings Page
  =============
  Configuration management:
    - Model + API Key (unified card: select provider → pick model → enter key)
    - Agent parameters (interval, max tool calls, timeout)
    - Password change
-->

<!-- ====================================================================== -->
<!-- Model & API Key (unified)                                              -->
<!-- ====================================================================== -->
<div class="settings-section">
  <h2 data-i18n="settings.model">Model Configuration</h2>
  <div class="card">
    <div class="form-group">
      <label for="model-provider" data-i18n="settings.provider">Provider</label>
      <select id="model-provider" class="form-control" onchange="onProviderChange()">
        <option value="deepseek">DeepSeek</option>
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
        <option value="google">Google (Gemini)</option>
        <option value="openrouter">OpenRouter</option>
        <option value="custom">Custom</option>
      </select>
    </div>

    <div class="form-group">
      <label for="model-name" data-i18n="settings.modelName">Model</label>
      <select id="model-preset" class="form-control" onchange="onPresetChange()">
        <!-- Dynamically populated by JS based on provider -->
      </select>
      <input type="text" id="model-name" class="form-control mt-sm hidden"
             placeholder="e.g. deepseek/deepseek-chat">
      <div class="hint" id="model-hint"></div>
    </div>

    <div class="form-group">
      <label for="model-api-key" data-i18n="settings.apiKey">API Key</label>
      <div class="flex gap-sm">
        <input type="password" id="model-api-key" class="form-control"
               placeholder="sk-..." style="flex:1;">
        <button class="btn btn-sm btn-outline" onclick="toggleKeyVisibility()" title="Show/Hide" id="btn-toggle-key">
          &#x1F441;
        </button>
      </div>
      <div class="hint" id="key-hint"></div>
    </div>

    <div id="advanced-toggle" class="text-sm text-muted mb-md" style="cursor:pointer;" onclick="toggleAdvanced()">
      &#x25B6; <span data-i18n="settings.advanced">Advanced options</span>
    </div>
    <div id="advanced-options" class="hidden">
      <div class="form-group">
        <label for="api-base" data-i18n="settings.apiBase">API Base URL (optional)</label>
        <input type="text" id="api-base" class="form-control" placeholder="https://api.deepseek.com">
        <div class="hint" data-i18n="settings.apiBaseHint">
          Leave empty to use the provider's default endpoint
        </div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="saveModelConfig()">
      <span data-i18n="settings.save">Save</span>
    </button>
  </div>
</div>

<!-- ====================================================================== -->
<!-- Agent Parameters                                                       -->
<!-- ====================================================================== -->
<div class="settings-section">
  <h2 data-i18n="settings.agentParams">Agent Parameters</h2>
  <div class="card">
    <div class="form-group">
      <label for="interval" data-i18n="settings.interval">Activation Interval (seconds)</label>
      <input type="number" id="interval" class="form-control" min="0" step="1" style="max-width:200px;">
      <div class="hint" data-i18n="settings.intervalHint">
        Seconds between rounds. Set to 0 for continuous execution (no delay).
      </div>
    </div>
    <div class="form-group">
      <label for="max-tools" data-i18n="settings.maxTools">Max Tool Calls Per Round</label>
      <input type="number" id="max-tools" class="form-control" min="1" step="1" style="max-width:200px;">
    </div>
    <div class="form-group">
      <label for="tool-timeout" data-i18n="settings.toolTimeout">Tool Execution Timeout (seconds)</label>
      <input type="number" id="tool-timeout" class="form-control" min="5" step="1" style="max-width:200px;">
    </div>
    <button class="btn btn-primary" onclick="saveAgentParams()">
      <span data-i18n="settings.save">Save</span>
    </button>
  </div>
</div>

<!-- ====================================================================== -->
<!-- Snapshot Auditor                                                       -->
<!-- ====================================================================== -->
<div class="settings-section">
  <h2 data-i18n="settings.snapshot">System Snapshot</h2>
  <div class="card">
    <div class="form-group">
      <label for="snapshot-model" data-i18n="settings.snapshotModel">Snapshot Auditor Model</label>
      <input type="text" id="snapshot-model" class="form-control" style="max-width:400px;"
             placeholder="e.g. deepseek/deepseek-chat">
      <div class="hint" data-i18n="settings.snapshotModelHint">
        The LLM model used to maintain the system asset inventory after each round. Leave empty to use the main agent model.
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveSnapshotConfig()">
      <span data-i18n="settings.save">Save</span>
    </button>
  </div>
</div>

<!-- ====================================================================== -->
<!-- Knowledge Base                                                         -->
<!-- ====================================================================== -->
<div class="settings-section">
  <h2 data-i18n="settings.knowledgeBase">Knowledge Base</h2>
  <div class="card">
    <div class="form-group">
      <label for="max-index-chars" data-i18n="settings.maxIndexChars">Index Character Limit</label>
      <input type="number" id="max-index-chars" class="form-control" min="500" step="100" style="max-width:200px;">
      <div class="hint" data-i18n="settings.maxIndexCharsHint">
        Maximum characters injected from knowledge/index.md into the prompt each round. The agent's index is truncated if it exceeds this limit.
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveKnowledgeConfig()">
      <span data-i18n="settings.save">Save</span>
    </button>
  </div>
</div>

<!-- ====================================================================== -->
<!-- Change Password                                                        -->
<!-- ====================================================================== -->
<div class="settings-section">
  <h2 data-i18n="settings.security">Security</h2>
  <div class="card">
    <div class="form-group">
      <label for="current-password" data-i18n="settings.currentPassword">Current Password</label>
      <input type="password" id="current-password" class="form-control" style="max-width:400px;">
    </div>
    <div class="form-group">
      <label for="new-password" data-i18n="settings.newPassword">New Password</label>
      <input type="password" id="new-password" class="form-control" style="max-width:400px;">
    </div>
    <button class="btn btn-primary" onclick="changePassword()">
      <span data-i18n="settings.changePassword">Change Password</span>
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/js/settings.js"></script>
{% endblock %}
